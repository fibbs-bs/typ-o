const sample = require('underscore');

const Paragraph = require('../models/schemas')["Paragraphs"];

const ctrl = {}; 

ctrl.randomParagraph = async (req,res)=>{
    // language
    lan = req.body.lan;
    //context
    context = req.body.context;
    // is language defined?
    if (!lan){
        // if not, define english as default language
        lan = "EN"
    }
    try{
        // is context defined?
        if (context){
            // if it is defined as random context
            if (context=='random'){ // generate a random paragraph generated by random words.
                a = await Paragraph.findOne({
                    wordCount: null,
                    language: lan
                })
                //take object and split it words
                text = a.text.split(",")
                wordCount = Math.floor(Math.random()*70)+45;
                console.log(wordCount)
                // select 'wordCount' random words
                a = sample.sample(text,wordCount)
                paragraphText = ""
                a.forEach(element => {
                    paragraphText+=" "+element   
                });
                paragraph = JSON.stringify({
                    text: paragraphText,
                    wordCount: wordCount
                },undefined,2);
            }
            else{
                res.status(500).send("Error, the context is send but his value is't a CONTEXT word")
            }
            
        }
        else{//Random parapraph obtained from books.
            paragraph = await Paragraph.aggregate([
                {$match:  { dictionary: null , language: lan} },
                {$sample: { size : 1 }}
            ]);
        }
        res.status(200).send(paragraph);
        
    }
    catch (err){
        res.status(500).send(err.message+"\nInternal Paragraph Controller Error! :c")
    }
    
    
};

module.exports = ctrl;